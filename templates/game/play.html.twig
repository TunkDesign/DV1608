{% extends "game/base.html.twig" %}

{% block title %}Play{% endblock %}

{% block body %}

<div class="container">
    <div class="game-wrapper">
<h1>Spela 21</h1>

<div>
    <div class="card-stack">
        <span class="card" id="draw-button">ðŸ‚ </span>
        
    </div>
    <p>Klicka pÃ¥ kortet fÃ¶r att dra</p>
</div>

<div class="mt-5">
    <h4>Spelarens kort (<span id="player-points">0</span>):</h4>
    <div class="card-row" id="player-cards"></div>
</div>

<div class="actions">
    <button id="stay-button" disabled>Stanna</button>
</div>

<div class="mt-5" id="dealer-section" style="display: none;">
    <h4>Bankens kort (<span id="dealer-points">0</span>):</h4>
    <div class="card-row" id="dealer-cards"></div>
</div>

<div class="mt-4">
    <h3 id="result" class="result"></h3>
</div>

</div>
</div>
<script>
    let playerCards = [];
    let dealerCards = [];
    let playerTurn = true;
    let playerPoints = 0;
    let dealerPoints = 0;

    document.getElementById('draw-button').addEventListener('click', () => {
        if (!playerTurn) return;

        fetch('/api/deck/draw')
            .then(response => response.json())
            .then(data => {
                playerPoints += data.drawn[0].value;
                document.getElementById('player-points').textContent = playerPoints;

                console.log(data);
                if (data.drawn) {
                    const cardDiv = document.createElement('div');
                    cardDiv.classList.add('card');
                    cardDiv.classList.add(data.drawn[0].color);
                    cardDiv.textContent = data.drawn[0].name;
                    document.getElementById('player-cards').appendChild(cardDiv);
                }
                if (playerPoints > 21) {
                    document.getElementById('result').textContent = "Du fÃ¶rlorade och banken vann!";
                    playerTurn = false;
                    //startDealerTurn();
                } else {
                    document.getElementById('stay-button').disabled = false;
                }
            });
    });

    document.getElementById('stay-button').addEventListener('click', () => {
        playerTurn = false;
        startDealerTurn();
    });

    function startDealerTurn() {
        document.getElementById('dealer-section').style.display = 'block';

        function drawNextCard() {
            fetch('/api/deck/draw')
                .then(response => response.json())
                .then(data => {
                    dealerPoints += data.drawn[0].value;
                    document.getElementById('dealer-points').textContent = dealerPoints;
                    if (data.drawn) {
                        const cardDiv = document.createElement('div');
                        cardDiv.classList.add('card');
                        cardDiv.classList.add(data.drawn[0].color);
                        cardDiv.textContent = data.drawn[0].name;
                        document.getElementById('dealer-cards').appendChild(cardDiv);
                    }
                    if (dealerPoints > 21) {
                        document.getElementById('result').textContent = "Vem vann?";
                    } else {
                        setTimeout(drawNextCard, 1500);
                    }
                });
        }

        drawNextCard();
    }
</script>

{% endblock %}